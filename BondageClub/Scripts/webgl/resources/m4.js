/*
 * Copyright 2014, Gregg Tavares.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Gregg Tavares. nor the names of his
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

(function(D,B){"function"===typeof define&&define.amd?define([],B):D.m4=B()})(this,function(){function D(a,b,c){c=c||new r(3);c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c}function B(a,b){b=b||new r(3);var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);1E-5<c&&(b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c);return b}function M(a,b,c){c=c||new r(3);c[0]=a[1]*b[2]-a[2]*b[1];c[1]=a[2]*b[0]-a[0]*b[2];c[2]=a[0]*b[1]-a[1]*b[0];return c}function N(a,b){var c=a[0]-b[0],d=a[1]-b[1],e=a[2]-b[2];return c*c+d*d+e*e}function X(a,b){b=b||new r(16);var c=a[0],d=a[1],e=a[2],h=a[3],f=a[4],g=a[5],p=a[6],m=a[7],n=a[8],l=a[9],x=a[10],q=a[11],v=a[12],u=a[13],t=a[14],w=a[15],A=x*w,k=t*q,y=p*w,z=t*m,C=p*q,O=x*m,E=e*w,P=t*h,F=e*q,G=x*h,H=e*m,I=p*h,J=n*u,K=v*l,L=f*u,B=v*g,D=f*l,Q=n*g,R=c*u,S=v*d,T=c*l,U=n*d,V=c*g,W=f*d,M=A*g+z*l+C*u-(k*g+y*l+O*u),N=k*d+E*l+G*u-(A*d+P*l+F*u);u=y*d+P*g+H*u-(z*d+E*g+I*u);d=O*d+F*g+I*l-(C*d+G*g+H*l);g=1/(c*M+f*N+n*u+v*d);b[0]=g*M;b[1]=g*N;b[2]=g*u;b[3]=g*d;b[4]=g*(k*f+y*n+O*v-(A*f+z*n+C*v));b[5]=g*(A*c+P*n+F*v-(k*c+E*n+G*v));b[6]=g*(z*c+E*f+I*v-(y*c+P*f+H*v));b[7]=g*(C*c+G*f+H*n-(O*c+F*f+I*n));b[8]=g*(J*m+B*q+D*w-(K*m+L*q+Q*w));b[9]=g*(K*h+R*q+U*w-(J*h+S*q+T*w));b[10]=g*(L*h+S*m+V*w-(B*h+R*m+W*w));b[11]=g*(Q*h+T*m+W*q-(D*h+U*m+V*q));b[12]=g*(L*x+Q*t+K*p-(D*t+J*p+B*x));b[13]=g*(T*t+J*e+S*x-(R*x+U*t+K*e));b[14]=g*(R*p+W*t+B*e-(V*t+L*e+S*p));b[15]=g*(V*x+D*e+U*p-(T*p+W*x+Q*e));return b}var r=Float32Array;return{copy:function(a,b){b=b||new r(16);b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b},lookAt:function(a,b,c,d){d=d||new r(16);b=B(D(a,b));c=B(M(c,b));var e=B(M(b,c));d[0]=c[0];d[1]=c[1];d[2]=c[2];d[3]=0;d[4]=e[0];d[5]=e[1];d[6]=e[2];d[7]=0;d[8]=b[0];d[9]=b[1];d[10]=b[2];d[11]=0;d[12]=a[0];d[13]=a[1];d[14]=a[2];d[15]=1;return d},addVectors:function(a,b,c){c=c||new r(3);c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c},subtractVectors:D,distance:function(a,b){return Math.sqrt(N(a,b))},distanceSq:N,normalize:B,compose:function(a,b,c,d){d=d||new r(16);var e=b[0],h=b[1],f=b[2],g=b[3],p=e+e,m=h+h,n=f+f;b=e*p;var l=e*m;e*=n;var x=h*m;h*=n;f*=n;p*=g;m*=g;g*=n;n=c[0];var q=c[1];c=c[2];d[0]=(1-(x+f))*n;d[1]=(l+g)*n;d[2]=(e-m)*n;d[3]=0;d[4]=(l-g)*q;d[5]=(1-(b+f))*q;d[6]=(h+p)*q;d[7]=0;d[8]=(e+m)*c;d[9]=(h-p)*c;d[10]=(1-(b+x))*c;d[11]=0;d[12]=a[0];d[13]=a[1];d[14]=a[2];d[15]=1;return d},cross:M,decompose:function(a,b,c,d){var e=m4.length(a.slice(0,3)),h=m4.length(a.slice(4,7)),f=m4.length(a.slice(8,11)),g=a[1],p=a[2],m=a[3],n=a[5],l=a[6],r=a[7],q=a[9],v=a[10],u=a[11],t=a[13],w=a[14],A=a[15],k=v*A,y=w*u,z=l*A,C=w*r,B=l*u,E=v*r;A*=p;w*=m;u*=p;v*=m;p*=r;m*=l;0>1/(a[0]*(k*n+C*q+B*t-(y*n+z*q+E*t))+a[4]*(y*g+A*q+v*t-(k*g+w*q+u*t))+a[8]*(z*g+w*n+p*t-(C*g+A*n+m*t))+a[12]*(E*g+u*n+m*q-(B*g+v*n+p*q)))&&(e=-e);b[0]=a[12];b[1]=a[13];b[2]=a[14];k=m4.copy(a);a=1/e;b=1/h;g=1/f;k[0]*=a;k[1]*=a;k[2]*=a;k[4]*=b;k[5]*=b;k[6]*=b;k[8]*=g;k[9]*=g;k[10]*=g;y=k[0];a=k[4];b=k[8];g=k[1];z=k[5];n=k[9];q=k[2];t=k[6];k=k[10];C=y+z+k;0<C?(k=.5/Math.sqrt(C+1),c[3]=.25/k,c[0]=(t-n)*k,c[1]=(b-q)*k,c[2]=(g-a)*k):y>z&&y>k?(k=2*Math.sqrt(1+y-z-k),c[3]=(t-n)/k,c[0]=.25*k,c[1]=(a+g)/k,c[2]=(b+q)/k):z>k?(k=2*Math.sqrt(1+z-y-k),c[3]=(b-q)/k,c[0]=(a+g)/k,c[1]=.25*k,c[2]=(n+t)/k):(k=2*Math.sqrt(1+k-y-z),c[3]=(g-a)/k,c[0]=(b+q)/k,c[1]=(n+t)/k,c[2]=.25*k);d[0]=e;d[1]=h;d[2]=f},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},identity:function(a){a=a||new r(16);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},transpose:function(a,b){b=b||new r(16);b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b},length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},orthographic:function(a,b,c,d,e,h,f){f=f||new r(16);f[0]=2/(b-a);f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/(d-c);f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=2/(e-h);f[11]=0;f[12]=(a+b)/(a-b);f[13]=(c+d)/(c-d);f[14]=(e+h)/(e-h);f[15]=1;return f},frustum:function(a,b,c,d,e,h,f){f=f||new r(16);var g=b-a,p=d-c,m=h-e;f[0]=2*e/g;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2*e/p;f[6]=0;f[7]=0;f[8]=(a+b)/g;f[9]=(d+c)/p;f[10]=-(h+e)/m;f[11]=-1;f[12]=0;f[13]=0;f[14]=-2*e*h/m;f[15]=0;return f},perspective:function(a,b,c,d,e){e=e||new r(16);a=Math.tan(.5*Math.PI-.5*a);var h=1/(c-d);e[0]=a/b;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=a;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=(c+d)*h;e[11]=-1;e[12]=0;e[13]=0;e[14]=c*d*h*2;e[15]=0;return e},translation:function(a,b,c,d){d=d||new r(16);d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=1;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=1;d[11]=0;d[12]=a;d[13]=b;d[14]=c;d[15]=1;return d},translate:function(a,b,c,d,e){e=e||new r(16);var h=a[0],f=a[1],g=a[2],p=a[3],m=a[4],n=a[5],l=a[6],x=a[7],q=a[8],v=a[9],u=a[10],t=a[11],w=a[12],A=a[13],k=a[14],y=a[15];a!==e&&(e[0]=h,e[1]=f,e[2]=g,e[3]=p,e[4]=m,e[5]=n,e[6]=l,e[7]=x,e[8]=q,e[9]=v,e[10]=u,e[11]=t);e[12]=h*b+m*c+q*d+w;e[13]=f*b+n*c+v*d+A;e[14]=g*b+l*c+u*d+k;e[15]=p*b+x*c+t*d+y;return e},xRotation:function(a,b){b=b||new r(16);var c=Math.cos(a),d=Math.sin(a);b[0]=1;b[1]=0;b[2]=0;b[3]=0;b[4]=0;b[5]=c;b[6]=d;b[7]=0;b[8]=0;b[9]=-d;b[10]=c;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},yRotation:function(a,b){b=b||new r(16);var c=Math.cos(a),d=Math.sin(a);b[0]=c;b[1]=0;b[2]=-d;b[3]=0;b[4]=0;b[5]=1;b[6]=0;b[7]=0;b[8]=d;b[9]=0;b[10]=c;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},zRotation:function(a,b){b=b||new r(16);var c=Math.cos(a),d=Math.sin(a);b[0]=c;b[1]=d;b[2]=0;b[3]=0;b[4]=-d;b[5]=c;b[6]=0;b[7]=0;b[8]=0;b[9]=0;b[10]=1;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},xRotate:function(a,b,c){c=c||new r(16);var d=a[4],e=a[5],h=a[6],f=a[7],g=a[8],p=a[9],m=a[10],n=a[11],l=Math.cos(b);b=Math.sin(b);c[4]=l*d+b*g;c[5]=l*e+b*p;c[6]=l*h+b*m;c[7]=l*f+b*n;c[8]=l*g-b*d;c[9]=l*p-b*e;c[10]=l*m-b*h;c[11]=l*n-b*f;a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]);return c},yRotate:function(a,b,c){c=c||new r(16);var d=a[0],e=a[1],h=a[2],f=a[3],g=a[8],p=a[9],m=a[10],n=a[11],l=Math.cos(b);b=Math.sin(b);c[0]=l*d-b*g;c[1]=l*e-b*p;c[2]=l*h-b*m;c[3]=l*f-b*n;c[8]=l*g+b*d;c[9]=l*p+b*e;c[10]=l*m+b*h;c[11]=l*n+b*f;a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]);return c},zRotate:function(a,b,c){c=c||new r(16);var d=a[0],e=a[1],h=a[2],f=a[3],g=a[4],p=a[5],m=a[6],n=a[7],l=Math.cos(b);b=Math.sin(b);c[0]=l*d+b*g;c[1]=l*e+b*p;c[2]=l*h+b*m;c[3]=l*f+b*n;c[4]=l*g-b*d;c[5]=l*p-b*e;c[6]=l*m-b*h;c[7]=l*n-b*f;a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]);return c},axisRotation:function(a,b,c){c=c||new r(16);var d=a[0],e=a[1];a=a[2];var h=Math.sqrt(d*d+e*e+a*a);d/=h;e/=h;a/=h;h=d*d;var f=e*e,g=a*a,p=Math.cos(b);b=Math.sin(b);var m=1-p;c[0]=h+(1-h)*p;c[1]=d*e*m+a*b;c[2]=d*a*m-e*b;c[3]=0;c[4]=d*e*m-a*b;c[5]=f+(1-f)*p;c[6]=e*a*m+d*b;c[7]=0;c[8]=d*a*m+e*b;c[9]=e*a*m-d*b;c[10]=g+(1-g)*p;c[11]=0;c[12]=0;c[13]=0;c[14]=0;c[15]=1;return c},axisRotate:function(a,b,c,d){d=d||new r(16);var e=b[0],h=b[1],f=b[2];b=Math.sqrt(e*e+h*h+f*f);e/=b;h/=b;f/=b;b=e*e;var g=h*h,p=f*f,m=Math.cos(c),n=Math.sin(c),l=1-m;c=b+(1-b)*m;b=e*h*l+f*n;var x=e*f*l-h*n,q=e*h*l-f*n;g+=(1-g)*m;var v=h*f*l+e*n,u=e*f*l+h*n;e=h*f*l-e*n;h=p+(1-p)*m;f=a[0];p=a[1];m=a[2];n=a[3];l=a[4];var t=a[5],w=a[6],A=a[7],k=a[8],y=a[9],z=a[10],C=a[11];d[0]=c*f+b*l+x*k;d[1]=c*p+b*t+x*y;d[2]=c*m+b*w+x*z;d[3]=c*n+b*A+x*C;d[4]=q*f+g*l+v*k;d[5]=q*p+g*t+v*y;d[6]=q*m+g*w+v*z;d[7]=q*n+g*A+v*C;d[8]=u*f+e*l+h*k;d[9]=u*p+e*t+h*y;d[10]=u*m+e*w+h*z;d[11]=u*n+e*A+h*C;a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]);return d},scaling:function(a,b,c,d){d=d||new r(16);d[0]=a;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=b;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=c;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return d},scale:function(a,b,c,d,e){e=e||new r(16);e[0]=b*a[0];e[1]=b*a[1];e[2]=b*a[2];e[3]=b*a[3];e[4]=c*a[4];e[5]=c*a[5];e[6]=c*a[6];e[7]=c*a[7];e[8]=d*a[8];e[9]=d*a[9];e[10]=d*a[10];e[11]=d*a[11];a!==e&&(e[12]=a[12],e[13]=a[13],e[14]=a[14],e[15]=a[15]);return e},multiply:function(a,b,c){c=c||new r(16);var d=b[0],e=b[1],h=b[2],f=b[3],g=b[4],p=b[5],m=b[6],n=b[7],l=b[8],x=b[9],q=b[10],v=b[11],u=b[12],t=b[13],w=b[14];b=b[15];var A=a[0],k=a[1],y=a[2],z=a[3],C=a[4],B=a[5],E=a[6],D=a[7],F=a[8],G=a[9],H=a[10],I=a[11],J=a[12],K=a[13],L=a[14];a=a[15];c[0]=d*A+e*C+h*F+f*J;c[1]=d*k+e*B+h*G+f*K;c[2]=d*y+e*E+h*H+f*L;c[3]=d*z+e*D+h*I+f*a;c[4]=g*A+p*C+m*F+n*J;c[5]=g*k+p*B+m*G+n*K;c[6]=g*y+p*E+m*H+n*L;c[7]=g*z+p*D+m*I+n*a;c[8]=l*A+x*C+q*F+v*J;c[9]=l*k+x*B+q*G+v*K;c[10]=l*y+x*E+q*H+v*L;c[11]=l*z+x*D+q*I+v*a;c[12]=u*A+t*C+w*F+b*J;c[13]=u*k+t*B+w*G+b*K;c[14]=u*y+t*E+w*H+b*L;c[15]=u*z+t*D+w*I+b*a;return c},inverse:X,transformVector:function(a,b,c){c=c||new r(4);for(var d=0;4>d;++d)for(var e=c[d]=0;4>e;++e)c[d]+=b[e]*a[4*e+d];return c},transformPoint:function(a,b,c){c=c||new r(3);var d=b[0],e=b[1];b=b[2];var h=d*a[3]+e*a[7]+b*a[11]+a[15];c[0]=(d*a[0]+e*a[4]+b*a[8]+a[12])/h;c[1]=(d*a[1]+e*a[5]+b*a[9]+a[13])/h;c[2]=(d*a[2]+e*a[6]+b*a[10]+a[14])/h;return c},transformDirection:function(a,b,c){c=c||new r(3);var d=b[0],e=b[1];b=b[2];c[0]=d*a[0]+e*a[4]+b*a[8];c[1]=d*a[1]+e*a[5]+b*a[9];c[2]=d*a[2]+e*a[6]+b*a[10];return c},transformNormal:function(a,b,c){c=c||new r(3);a=X(a);var d=b[0],e=b[1];b=b[2];c[0]=d*a[0]+e*a[1]+b*a[2];c[1]=d*a[4]+e*a[5]+b*a[6];c[2]=d*a[8]+e*a[9]+b*a[10];return c},setDefaultType:function(a){var b=r;r=a;return b}}});